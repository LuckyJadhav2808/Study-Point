<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Study Hub</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="icon2_192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="icon2_512x512.png" sizes="512x512">

    <link rel="apple-touch-icon" href="icon2_180x180.png">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-left">
                <button id="darkModeToggle" class="icon-button"><i class="fas fa-moon"></i></button>
            </div>
            <h1 class="app-title">My Study Hub</h1>
            <div class="header-right">
                <button id="calculatorButton" class="icon-button"><i class="fas fa-calculator"></i></button>
            </div>
        </header>

        <main class="content">
            <section id="notesSection" class="section active">
                <div class="section-header">
                    <h2>Notes Section</h2>
                    <button id="createNewNoteBtn" class="add-new-btn"><i class="fas fa-plus"></i> New Note</button>
                </div>
                <div class="notes-container">
                    <h3>Your Notes</h3>
                    <ul id="notesList" class="styled-list notes-list">
                        <p class="placeholder-text">No notes yet. Click 'New Note' to create one!</p>
                    </ul>

                    <h3 class="mt-30">Current Note: <span id="currentNoteTitleDisplay">Not Loaded</span></h3>
                    <div id="editor">
                        </div>
                    <button id="saveCurrentNoteBtn" class="action-btn save-btn mt-15"><i class="fas fa-save"></i> Save Current Note</button>
                    <p class="small-text">Notes are saved in your browser's local storage. Select a note above or create a new one.</p>

                    <h3 class="mt-30">PDF Notes (Local Storage - Limited Capacity)</h3>
                    <div class="pdf-upload-area">
                        <p>Upload your PDF notes here:</p>
                        <input type="file" id="pdfUploadInput" accept=".pdf">
                        <button id="uploadPdfBtn" class="action-btn"><i class="fas fa-upload"></i> Upload PDF</button>
                        <p class="small-text">Warning: Storing large PDFs in local storage is not recommended due to size limits and performance. This is for demonstration.</p>
                        <div id="pdfList" class="pdf-list">
                            </div>
                    </div>
                </div>
            </section>

            <section id="todoSection" class="section">
                <div class="section-header">
                    <h2>To-Do List</h2>
                </div>
                <div class="todo-input-group">
                    <input type="text" id="todoInput" placeholder="Enter new task..." class="text-input">
                    <button id="addTodoItemBtn" class="action-btn"><i class="fas fa-plus"></i> Add</button>
                </div>
                <ul id="todoList" class="styled-list">
                    </ul>
                <p class="small-text">To-Do items are saved in your browser's local storage.</p>
            </section>

            <section id="timetableSection" class="section">
                <div class="section-header">
                    <h2>Editable Timetable</h2>
                </div>
                <div class="timetable-grid">
                    <p class="small-text">Timetable data is saved in your browser's local storage.</p>
                    <table class="timetable-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Monday</th>
                                <th>Tuesday</th>
                                <th>Wednesday</th>
                                <th>Thursday</th>
                                <th>Friday</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                    <button id="saveTimetableBtn" class="action-btn save-btn mt-20"><i class="fas fa-save"></i> Save Timetable</button>
                </div>
            </section>

            <section id="homeworkSection" class="section">
                <div class="section-header">
                    <h2>Homework</h2>
                </div>
                <div class="homework-input-group">
                    <input type="text" id="homeworkInput" placeholder="e.g., Math Ch 3 exercises" class="text-input">
                    <input type="date" id="homeworkDueDate" class="text-input">
                    <button id="addHomeworkItemBtn" class="action-btn"><i class="fas fa-plus"></i> Add</button>
                </div>
                <ul id="homeworkList" class="styled-list">
                    </ul>
                <p class="small-text">Homework items are saved in your browser's local storage.</p>
            </section>

            <section id="linksSection" class="section">
                <div class="section-header">
                    <h2>Links Section</h2>
                </div>
                <div class="link-input-group">
                    <input type="text" id="linkNameInput" placeholder="Link Name" class="text-input">
                    <input type="url" id="linkUrlInput" placeholder="https://example.com" class="text-input">
                    <button id="addLinkItemBtn" class="action-btn"><i class="fas fa-plus"></i> Add</button>
                </div>
                <ul id="linksList" class="styled-list">
                    </ul>
                <p class="small-text">Links are saved in your browser's local storage.</p>
            </section>

            <section id="backupRestoreSection" class="section">
                <div class="section-header">
                    <h2>Backup & Restore Data</h2>
                </div>
                <div class="backup-restore-area">
                    <p class="small-text">Export all your data (notes, to-dos, timetable, etc.) to a JSON file for backup.</p>
                    <button id="exportDataBtn" class="action-btn"><i class="fas fa-download"></i> Export All Data</button>
                    <div class="import-section mt-15">
                        <p class="small-text">Import data from a previously exported JSON backup file.</p>
                        <input type="file" id="importFileInput" accept=".json">
                        <button id="importDataBtn" class="action-btn save-btn"><i class="fas fa-upload"></i> Import Data</button>
                        <p class="small-text import-warning">Warning: Importing data will overwrite your current data. Be careful!</p>
                    </div>
                </div>
            </section>
        </main>

        <nav class="bottom-nav">
            <button class="nav-button active" data-target="notesSection">
                <i class="fas fa-book"></i>
                <span>Notes</span>
            </button>
            <button class="nav-button" data-target="todoSection">
                <i class="fas fa-list-check"></i>
                <span>To-Do</span>
            </button>
            <button class="nav-button" data-target="timetableSection">
                <i class="fas fa-calendar-alt"></i>
                <span>Timetable</span>
            </button>
            <button class="nav-button" data-target="homeworkSection">
                <i class="fas fa-clipboard-check"></i>
                <span>Homework</span>
            </button>
            <button class="nav-button" data-target="linksSection">
                <i class="fas fa-link"></i>
                <span>Links</span>
            </button>
            <button class="nav-button" data-target="backupRestoreSection">
                <i class="fas fa-cloud-arrow-up"></i>
                <span>Backup</span>
            </button>
        </nav>
    </div>

    <div id="calculatorModal" class="modal">
        <div class="modal-content calculator-content">
            <span class="close-button" id="closeCalculatorBtn">&times;</span>
            <h3>Calculator</h3>
            <div class="calculator">
                <input type="text" class="calculator-display" id="calcDisplay" value="0" readonly>
                <div class="calculator-buttons">
                    <button class="btn clear" data-action="clear">C</button>
                    <button class="btn backspace" data-action="backspace"><i class="fas fa-backspace"></i></button>
                    <button class="btn operator" data-value="%">%</button>
                    <button class="btn operator" data-value="/">/</button>

                    <button class="btn number" data-value="7">7</button>
                    <button class="btn number" data-value="8">8</button>
                    <button class="btn number" data-value="9">9</button>
                    <button class="btn operator" data-value="*">x</button>

                    <button class="btn number" data-value="4">4</button>
                    <button class="btn number" data-value="5">5</button>
                    <button class="btn number" data-value="6">6</button>
                    <button class="btn operator" data-value="-">-</button>

                    <button class="btn number" data-value="1">1</button>
                    <button class="btn number" data-value="2">2</button>
                    <button class="btn number" data-value="3">3</button>
                    <button class="btn operator" data-value="+">+</button>

                    <button class="btn number zero" data-value="0">0</button>
                    <button class="btn number" data-value=".">.</button>
                    <button class="btn equals" data-action="equals">=</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const navButtons = document.querySelectorAll('.nav-button');
            const sections = document.querySelectorAll('.section');
            const darkModeToggle = document.getElementById('darkModeToggle');
            const calculatorButton = document.getElementById('calculatorButton');
            const calculatorModal = document.getElementById('calculatorModal');
            const closeCalculatorBtn = document.getElementById('closeCalculatorBtn');

            // --- Utility Functions ---
            // Function to generate a unique ID
            function generateUniqueId() {
                return '_' + Math.random().toString(36).substr(2, 9);
            }

            // Function to reload all data and re-render UI components
            function reloadAllData() {
                // Reload individual data sets
                allNotes = JSON.parse(localStorage.getItem('allNotes')) || [];
                todos = JSON.parse(localStorage.getItem('todos')) || [];
                homeworks = JSON.parse(localStorage.getItem('homeworks')) || [];
                links = JSON.parse(localStorage.getItem('links')) || [];
                pdfs = JSON.parse(localStorage.getItem('pdfs')) || [];
                activeNoteId = localStorage.getItem('activeNoteId');

                // Re-render UI components
                renderNotesList();
                // If there's an active note, load it, otherwise set default editor content
                if (activeNoteId) {
                    loadNoteIntoEditor(activeNoteId);
                } else if (allNotes.length > 0) {
                    loadNoteIntoEditor(allNotes[0].id); // Load the first note if no active note
                } else {
                    editor.setContents([{ insert: 'Welcome to your Study Hub Notes! Click "New Note" to create one!' }]);
                    currentNoteTitleDisplay.textContent = 'Not Loaded';
                }

                renderPdfs();
                renderTodos();
                loadTimetable(); // Make sure timetable is re-rendered correctly
                renderHomeworks();
                renderLinks();
                loadDarkModePreference(); // Re-apply dark mode preference
                alert('All data reloaded!');
            }


            // --- Dark Mode Functionality ---
            function loadDarkModePreference() {
                const isDarkMode = localStorage.getItem('darkMode') === 'enabled';
                if (isDarkMode) {
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode'); // Ensure it's off if disabled
                }
            }

            darkModeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                if (document.body.classList.contains('dark-mode')) {
                    localStorage.setItem('darkMode', 'enabled');
                } else {
                    localStorage.setItem('darkMode', 'disabled');
                }
            });

            loadDarkModePreference(); // Load preference on start

            // --- Navigation Functionality ---
            function showSection(targetId) {
                sections.forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(targetId).classList.add('active');

                navButtons.forEach(button => {
                    button.classList.remove('active');
                });
                document.querySelector(`.nav-button[data-target="${targetId}"]`).classList.add('active');
            }

            // Set initial active section (Notes)
            showSection('notesSection');

            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetId = button.dataset.target;
                    showSection(targetId);
                });
            });


            // --- Calculator Functionality ---
            // Ensure modal is hidden on load
            calculatorModal.style.display = 'none';

            calculatorButton.addEventListener('click', () => {
                calculatorModal.style.display = 'flex'; // Use flex to center the modal
            });

            closeCalculatorBtn.addEventListener('click', () => {
                calculatorModal.style.display = 'none';
            });

            window.addEventListener('click', (event) => {
                if (event.target == calculatorModal) {
                    calculatorModal.style.display = 'none';
                }
            });

            const calcDisplay = document.getElementById('calcDisplay');
            const calcButtons = document.querySelector('.calculator-buttons');
            let currentInput = '0';
            let operator = null;
            let firstOperand = null;
            let waitingForSecondOperand = false;

            function updateDisplay() {
                calcDisplay.value = currentInput;
            }

            function inputDigit(digit) {
                if (waitingForSecondOperand) {
                    currentInput = digit;
                    waitingForSecondOperand = false;
                } else {
                    currentInput = currentInput === '0' ? digit : currentInput + digit;
                }
                updateDisplay();
            }

            function inputDecimal(dot) {
                if (waitingForSecondOperand) { // If starting a new number after an operator, always start with '0.'
                    currentInput = '0.';
                    waitingForSecondOperand = false;
                } else if (!currentInput.includes(dot)) {
                    currentInput += dot;
                }
                updateDisplay();
            }

            function handleOperator(nextOperator) {
                const inputValue = parseFloat(currentInput);

                if (operator && waitingForSecondOperand) {
                    operator = nextOperator;
                    return;
                }

                if (firstOperand === null) {
                    firstOperand = inputValue;
                } else if (operator) {
                    const result = operate(firstOperand, inputValue, operator);
                    currentInput = String(result);
                    firstOperand = result;
                }

                waitingForSecondOperand = true;
                operator = nextOperator;
                updateDisplay();
            }

            function operate(num1, num2, op) {
                if (op === '+') return num1 + num2;
                if (op === '-') return num1 - num2;
                if (op === '*') return num1 * num2;
                if (op === '/') {
                    if (num2 === 0) {
                        alert("Cannot divide by zero!");
                        return 'Error'; // Return a string to indicate error
                    }
                    return num1 / num2;
                }
                if (op === '%') return (num1 / 100) * num2; // percentage of a number
                return num2; // Default case
            }

            function resetCalculator() {
                currentInput = '0';
                operator = null;
                firstOperand = null;
                waitingForSecondOperand = false;
                updateDisplay();
            }

            function backspace() {
                currentInput = currentInput.slice(0, -1);
                if (currentInput === '' || currentInput === '-') { // If only '-' left or empty
                    currentInput = '0';
                }
                updateDisplay();
            }

            calcButtons.addEventListener('click', (event) => {
                const { target } = event;
                if (!target.matches('button')) {
                    return;
                }

                if (target.classList.contains('number')) {
                    inputDigit(target.dataset.value);
                    return;
                }

                if (target.dataset.value === '.') {
                    inputDecimal(target.dataset.value);
                    return;
                }

                if (target.classList.contains('operator')) {
                    handleOperator(target.dataset.value);
                    return;
                }

                if (target.dataset.action === 'equals') {
                    if (operator && firstOperand !== null) { // Only calculate if there's an active operation
                        const result = operate(firstOperand, parseFloat(currentInput), operator);
                        currentInput = String(result);
                        firstOperand = null; // Reset firstOperand after equals
                        operator = null; // Clear operator
                        waitingForSecondOperand = false; // Allow new calculation to start
                        updateDisplay();
                    }
                    return;
                }

                if (target.dataset.action === 'clear') {
                    resetCalculator();
                    return;
                }

                if (target.dataset.action === 'backspace') {
                    backspace();
                    return;
                }
            });

            // Initialize calculator display
            updateDisplay();

            // --- Notes Section Functionality (Quill.js & LocalStorage for multiple notes) ---
            const editor = new Quill('#editor', {
                theme: 'snow',
                placeholder: 'Start writing your notes here...',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline', 'strike'],
                        ['blockquote', 'code-block'],
                        [{ 'header': 1 }, { 'header': 2 }],
                        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                        [{ 'script': 'sub' }, { 'script': 'super' }],
                        [{ 'indent': '-1' }, { 'indent': '+1' }],
                        [{ 'direction': 'rtl' }],
                        [{ 'size': ['small', false, 'large', 'huge'] }],
                        [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'font': [] }],
                        [{ 'align': [] }],
                        ['clean']
                    ]
                }
            });

            const createNewNoteBtn = document.getElementById('createNewNoteBtn');
            const saveCurrentNoteBtn = document.getElementById('saveCurrentNoteBtn');
            const notesListElement = document.getElementById('notesList');
            const currentNoteTitleDisplay = document.getElementById('currentNoteTitleDisplay');

            let allNotes = JSON.parse(localStorage.getItem('allNotes')) || [];
            let activeNoteId = localStorage.getItem('activeNoteId'); // Track which note is currently open

            // Render the list of notes
            function renderNotesList() {
                notesListElement.innerHTML = ''; // Clear existing list
                if (allNotes.length === 0) {
                    notesListElement.innerHTML = '<p class="placeholder-text">No notes yet. Click \'New Note\' to create one!</p>';
                    return;
                }

                allNotes.forEach(note => {
                    const li = document.createElement('li');
                    li.className = `note-item ${note.id === activeNoteId ? 'active-note' : ''}`;
                    li.dataset.noteId = note.id;
                    li.innerHTML = `
                        <span class="note-title">${note.title}</span>
                        <div class="note-actions">
                            <button class="load-note-btn action-btn small-btn" data-note-id="${note.id}" title="Load Note"><i class="fas fa-folder-open"></i></button>
                            <button class="delete-note-btn action-btn small-btn delete-btn" data-note-id="${note.id}" title="Delete Note"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    notesListElement.appendChild(li);
                });
            }

            // Load a specific note into the editor
            function loadNoteIntoEditor(noteId) {
                const noteToLoad = allNotes.find(note => note.id === noteId);
                if (noteToLoad) {
                    // Save the current note before loading a new one if there was an active note
                    if (activeNoteId && activeNoteId !== noteId) {
                        const currentNote = allNotes.find(note => note.id === activeNoteId);
                        if (currentNote) {
                            currentNote.content = JSON.stringify(editor.getContents());
                            localStorage.setItem('allNotes', JSON.stringify(allNotes)); // Persist changes
                        }
                    }

                    editor.setContents(JSON.parse(noteToLoad.content));
                    currentNoteTitleDisplay.textContent = noteToLoad.title;
                    activeNoteId = noteId;
                    localStorage.setItem('activeNoteId', activeNoteId); // Save active note ID
                    renderNotesList(); // Update active class
                    // alert(`Note "${noteToLoad.title}" loaded!`); // Visual confirmation - commented for less popups
                } else {
                    // If note not found (e.g., deleted), clear editor
                    editor.setContents([{ insert: 'Note not found. Create a new one.' }]);
                    currentNoteTitleDisplay.textContent = 'Not Loaded'; // Reset display
                    activeNoteId = null;
                    localStorage.removeItem('activeNoteId');
                    renderNotesList();
                }
            }

            // Handle creating a new note
            createNewNoteBtn.addEventListener('click', () => {
                const noteTitle = prompt("Enter a title for your new note:");
                if (noteTitle && noteTitle.trim() !== "") {
                    // Save the current note first if one is active
                    if (activeNoteId) {
                        const currentNote = allNotes.find(note => note.id === activeNoteId);
                        if (currentNote) {
                            currentNote.content = JSON.stringify(editor.getContents());
                            localStorage.setItem('allNotes', JSON.stringify(allNotes)); // Save changes to allNotes
                        }
                    }

                    const newNote = {
                        id: generateUniqueId(),
                        title: noteTitle.trim(),
                        content: JSON.stringify([{ insert: 'Start writing your new note here...' }]),
                        createdAt: new Date().toISOString()
                    };
                    allNotes.push(newNote);
                    localStorage.setItem('allNotes', JSON.stringify(allNotes));
                    loadNoteIntoEditor(newNote.id); // Load the new note
                    alert(`New note "${newNote.title}" created!`);
                } else {
                    alert("Note title cannot be empty!");
                }
            });

            // Handle saving the current note
            saveCurrentNoteBtn.addEventListener('click', () => {
                if (activeNoteId) {
                    const noteToSave = allNotes.find(note => note.id === activeNoteId);
                    if (noteToSave) {
                        noteToSave.content = JSON.stringify(editor.getContents());
                        localStorage.setItem('allNotes', JSON.stringify(allNotes));
                        alert(`Note "${noteToSave.title}" saved!`);
                    }
                } else {
                    alert("No note selected. Create a new note first!");
                }
            });

            // Handle loading and deleting notes from the list
            notesListElement.addEventListener('click', (event) => {
                const target = event.target;
                // Use closest to ensure click on icon inside button also works
                const loadBtn = target.closest('.load-note-btn');
                const deleteBtn = target.closest('.delete-note-btn');

                if (loadBtn) {
                    const noteId = loadBtn.dataset.noteId;
                    loadNoteIntoEditor(noteId); // Load the clicked note
                } else if (deleteBtn) {
                    const noteId = deleteBtn.dataset.noteId;
                    const noteTitleToDelete = allNotes.find(note => note.id === noteId)?.title || "this note";

                    if (confirm(`Are you sure you want to delete "${noteTitleToDelete}"?`)) {
                        allNotes = allNotes.filter(note => note.id !== noteId);
                        localStorage.setItem('allNotes', JSON.stringify(allNotes));
                        renderNotesList();
                        if (activeNoteId === noteId) {
                            // If the deleted note was active, clear editor and reset activeNoteId
                            editor.setContents([{ insert: 'Note deleted. Create or load another note.' }]);
                            currentNoteTitleDisplay.textContent = 'Not Loaded'; // Reset display
                            activeNoteId = null;
                            localStorage.removeItem('activeNoteId');
                        }
                        alert('Note deleted.');
                    }
                }
            });

            // Initial load of notes list and active note
            renderNotesList();
            if (activeNoteId) {
                loadNoteIntoEditor(activeNoteId);
            } else if (allNotes.length > 0) {
                // If no activeNoteId but there are notes, load the first one
                loadNoteIntoEditor(allNotes[0].id);
            } else {
                // If no notes at all, set a default message and title
                editor.setContents([{ insert: 'Welcome to your Study Hub Notes! Click "New Note" to get started.' }]);
                currentNoteTitleDisplay.textContent = 'Not Loaded';
            }


            // --- PDF Notes (Base64 in Local Storage - for demonstration, limits apply) ---
            const pdfUploadInput = document.getElementById('pdfUploadInput');
            const uploadPdfBtn = document.getElementById('uploadPdfBtn');
            const pdfList = document.getElementById('pdfList');

            let pdfs = JSON.parse(localStorage.getItem('pdfs')) || [];

            function renderPdfs() {
                pdfList.innerHTML = '';
                if (pdfs.length === 0) {
                    pdfList.innerHTML = '<p class="placeholder-text">No PDFs uploaded yet.</p>';
                    return;
                }
                pdfs.forEach((pdf, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span>${pdf.name}</span>
                        <div class="pdf-actions">
                            <button class="view-pdf-btn action-btn small-btn" data-index="${index}"><i class="fas fa-eye"></i> View</button>
                            <button class="delete-pdf-btn action-btn small-btn delete-btn" data-index="${index}"><i class="fas fa-trash"></i> Delete</button>
                        </div>
                    `;
                    pdfList.appendChild(li);
                });
            }

            uploadPdfBtn.addEventListener('click', () => {
                const file = pdfUploadInput.files[0];
                if (file && file.type === 'application/pdf') {
                    if (file.size > 5 * 1024 * 1024) { // Warning for files > 5MB
                        alert('Warning: This PDF is very large. Storing large files in local storage may cause performance issues or exceed limits. For persistent storage, a backend server is recommended.');
                    }
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const base64Pdf = e.target.result;
                        pdfs.push({ name: file.name, data: base64Pdf });
                        localStorage.setItem('pdfs', JSON.stringify(pdfs));
                        renderPdfs();
                        pdfUploadInput.value = ''; // Clear file input
                        alert('PDF uploaded (to local storage)!');
                    };
                    reader.readAsDataURL(file);
                } else {
                    alert('Please select a PDF file.');
                }
            });

            pdfList.addEventListener('click', (event) => {
                if (event.target.classList.contains('view-pdf-btn') || event.target.closest('.view-pdf-btn')) {
                    const index = event.target.dataset.index || event.target.closest('.view-pdf-btn').dataset.index;
                    const pdfData = pdfs[index].data;
                    const newWindow = window.open();
                    newWindow.document.write(`<iframe src="${pdfData}" style="width:100%; height:100vh;" frameborder="0"></iframe>`);
                    newWindow.document.close();
                } else if (event.target.classList.contains('delete-pdf-btn') || event.target.closest('.delete-pdf-btn')) {
                    const index = event.target.dataset.index || event.target.closest('.delete-pdf-btn').dataset.index;
                    if (confirm(`Are you sure you want to delete "${pdfs[index].name}"?`)) {
                        pdfs.splice(index, 1);
                        localStorage.setItem('pdfs', JSON.stringify(pdfs));
                        renderPdfs();
                        alert('PDF deleted.');
                    }
                }
            });

            renderPdfs(); // Render PDFs on page load

            // --- To-Do List Functionality (Local Storage) ---
            const todoInput = document.getElementById('todoInput');
            const addTodoItemBtn = document.getElementById('addTodoItemBtn');
            const todoList = document.getElementById('todoList');

            let todos = JSON.parse(localStorage.getItem('todos')) || [];

            function renderTodos() {
                todoList.innerHTML = '';
                if (todos.length === 0) {
                    todoList.innerHTML = '<p class="placeholder-text">No tasks yet! Add one to get started.</p>';
                    return;
                }
                todos.forEach((todo, index) => {
                    const li = document.createElement('li');
                    li.className = todo.completed ? 'completed' : '';
                    li.innerHTML = `
                        <span class="todo-text">${todo.text}</span>
                        <div class="todo-actions">
                            <button class="complete-todo-btn action-btn small-btn" data-index="${index}"><i class="fas fa-check"></i></button>
                            <button class="delete-todo-btn action-btn small-btn delete-btn" data-index="${index}"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    todoList.appendChild(li);
                });
            }

            addTodoItemBtn.addEventListener('click', () => {
                const taskText = todoInput.value.trim();
                if (taskText) {
                    todos.push({ text: taskText, completed: false });
                    localStorage.setItem('todos', JSON.stringify(todos));
                    todoInput.value = '';
                    renderTodos();
                }
            });

            todoList.addEventListener('click', (event) => {
                if (event.target.classList.contains('delete-todo-btn') || event.target.closest('.delete-todo-btn')) {
                    const index = event.target.dataset.index || event.target.closest('.delete-todo-btn').dataset.index;
                    todos.splice(index, 1);
                    localStorage.setItem('todos', JSON.stringify(todos));
                    renderTodos();
                } else if (event.target.classList.contains('complete-todo-btn') || event.target.closest('.complete-todo-btn')) {
                    const index = event.target.dataset.index || event.target.closest('.complete-todo-btn').dataset.index;
                    todos[index].completed = !todos[index].completed;
                    localStorage.setItem('todos', JSON.stringify(todos));
                    renderTodos();
                }
            });

            renderTodos(); // Render todos on page load

            // --- Timetable Section Functionality (Local Storage) ---
            const timetableTableBody = document.querySelector('.timetable-table tbody');
            const saveTimetableBtn = document.getElementById('saveTimetableBtn');

            // Default timetable structure (if no data in local storage)
            const defaultTimetableRows = [
                { time: '9:00 AM', classes: ['', '', '', '', ''] },
                { time: '10:00 AM', classes: ['', '', '', '', ''] },
                { time: '11:00 AM', classes: ['', '', '', '', ''] },
                { time: '12:00 PM', classes: ['', '', '', '', ''] },
                { time: '1:00 PM', classes: ['', '', '', '', ''] },
                { time: '2:00 PM', classes: ['', '', '', '', ''] },
                { time: '3:00 PM', classes: ['', '', '', '', ''] },
            ];

            // Render timetable from data
            function renderTimetable(data) {
                timetableTableBody.innerHTML = ''; // Clear existing rows
                data.forEach(rowData => {
                    const tr = document.createElement('tr');
                    // Make the time cell contenteditable and use data-placeholder
                    const timeContent = rowData.time ? rowData.time : '';
                    tr.innerHTML = `<td contenteditable="true" data-placeholder="Time">${timeContent}</td>` +
                                   rowData.classes.map(cls => `<td contenteditable="true" data-placeholder="Add class">${cls}</td>`).join('');
                    timetableTableBody.appendChild(tr);
                });
                applyTimetablePlaceholders(); // Apply placeholders after rendering
            }

            // Function to apply/update placeholders based on cell content
            function applyTimetablePlaceholders() {
                document.querySelectorAll('.timetable-table td[contenteditable="true"]').forEach(cell => {
                    if (cell.textContent.trim() === '') {
                        cell.classList.add('empty-editable-cell');
                    } else {
                        cell.classList.remove('empty-editable-cell');
                    }
                });
            }

            // Load timetable data
            function loadTimetable() {
                const savedTimetable = localStorage.getItem('timetable');
                if (savedTimetable) {
                    try {
                        const parsedData = JSON.parse(savedTimetable);
                        renderTimetable(parsedData);
                    } catch (e) {
                        console.error("Error parsing saved timetable data, loading default:", e);
                        renderTimetable(defaultTimetableRows); // Fallback to default
                    }
                } else {
                    renderTimetable(defaultTimetableRows); // Load default if nothing saved
                }
            }

            // Save timetable data
            saveTimetableBtn.addEventListener('click', () => {
                const timetableData = [];
                timetableTableBody.querySelectorAll('tr').forEach(row => {
                    // Select all contenteditable cells in the row
                    const allCellsInRow = Array.from(row.querySelectorAll('td[contenteditable="true"]'));
                    if (allCellsInRow.length > 0) {
                        const time = allCellsInRow[0].textContent.trim(); // First cell is time
                        const classes = allCellsInRow.slice(1).map(cell => cell.textContent.trim()); // Rest are classes
                        timetableData.push({ time: time, classes: classes });
                    }
                });
                localStorage.setItem('timetable', JSON.stringify(timetableData));
                alert('Timetable saved to local storage!');
                applyTimetablePlaceholders(); // Re-apply placeholders after save (in case cells were cleared)
            });

            // Add an input event listener to manage placeholder visibility as user types
            timetableTableBody.addEventListener('input', (event) => {
                const target = event.target;
                if (target.matches('td[contenteditable="true"]')) {
                    if (target.textContent.trim() !== '') {
                        target.classList.remove('empty-editable-cell');
                    } else {
                        target.classList.add('empty-editable-cell');
                    }
                }
            });

            loadTimetable(); // Initial load of timetable on page load


            // --- Homework Section Functionality (Local Storage) ---
            const homeworkInput = document.getElementById('homeworkInput');
            const homeworkDueDate = document.getElementById('homeworkDueDate');
            const addHomeworkItemBtn = document.getElementById('addHomeworkItemBtn');
            const homeworkList = document.getElementById('homeworkList');

            let homeworks = JSON.parse(localStorage.getItem('homeworks')) || [];

            function renderHomeworks() {
                homeworkList.innerHTML = '';
                if (homeworks.length === 0) {
                    homeworkList.innerHTML = '<p class="placeholder-text">No homework assigned yet! Add one to get started.</p>';
                    return;
                }
                homeworks.forEach((hw, index) => {
                    const li = document.createElement('li');
                    li.className = hw.completed ? 'completed' : '';
                    li.innerHTML = `
                        <span class="homework-text">${hw.text} (Due: ${hw.dueDate})</span>
                        <div class="homework-actions">
                            <button class="complete-homework-btn action-btn small-btn" data-index="${index}"><i class="fas fa-check"></i></button>
                            <button class="delete-homework-btn action-btn small-btn delete-btn" data-index="${index}"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    homeworkList.appendChild(li);
                });
            }

            addHomeworkItemBtn.addEventListener('click', () => {
                const hwText = homeworkInput.value.trim();
                const hwDue = homeworkDueDate.value;
                if (hwText && hwDue) {
                    homeworks.push({ text: hwText, dueDate: hwDue, completed: false });
                    localStorage.setItem('homeworks', JSON.stringify(homeworks));
                    homeworkInput.value = '';
                    homeworkDueDate.value = '';
                    renderHomeworks();
                } else {
                    alert('Please enter both homework description and due date.');
                }
            });

            homeworkList.addEventListener('click', (event) => {
                if (event.target.classList.contains('delete-homework-btn') || event.target.closest('.delete-homework-btn')) {
                    const index = event.target.dataset.index || event.target.closest('.delete-homework-btn').dataset.index;
                    homeworks.splice(index, 1);
                    localStorage.setItem('homeworks', JSON.stringify(homeworks));
                    renderHomeworks();
                } else if (event.target.classList.contains('complete-homework-btn') || event.target.closest('.complete-homework-btn')) {
                    const index = event.target.dataset.index || event.target.closest('.complete-homework-btn').dataset.index;
                    homeworks[index].completed = !homeworks[index].completed;
                    localStorage.setItem('homeworks', JSON.stringify(homeworks));
                    renderHomeworks();
                }
            });

            renderHomeworks(); // Render homeworks on page load

            // --- Links Section Functionality (Local Storage) ---
            const linkNameInput = document.getElementById('linkNameInput');
            const linkUrlInput = document.getElementById('linkUrlInput');
            const addLinkItemBtn = document.getElementById('addLinkItemBtn');
            const linksList = document.getElementById('linksList');

            let links = JSON.parse(localStorage.getItem('links')) || [];

            function renderLinks() {
                linksList.innerHTML = '';
                if (links.length === 0) {
                    linksList.innerHTML = '<p class="placeholder-text">No links yet! Add one to get started.</p>';
                    return;
                }
                links.forEach((link, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <a href="${link.url}" target="_blank">${link.name}</a>
                        <button class="delete-link-btn action-btn small-btn" data-index="${index}"><i class="fas fa-trash"></i></button>
                    `;
                    linksList.appendChild(li);
                });
            }

            addLinkItemBtn.addEventListener('click', () => {
                const linkName = linkNameInput.value.trim();
                const linkUrl = linkUrlInput.value.trim();
                if (linkName && linkUrl) {
                    try {
                        new URL(linkUrl); // Validate URL
                        links.push({ name: linkName, url: linkUrl });
                        localStorage.setItem('links', JSON.stringify(links));
                        linkNameInput.value = '';
                        linkUrlInput.value = '';
                        renderLinks();
                    } catch (e) {
                        alert('Please enter a valid URL.');
                    }
                } else {
                    alert('Please enter both link name and URL.');
                }
            });

            linksList.addEventListener('click', (event) => {
                if (event.target.classList.contains('delete-link-btn') || event.target.closest('.delete-link-btn')) {
                    const index = event.target.dataset.index || event.target.closest('.delete-link-btn').dataset.index;
                    links.splice(index, 1);
                    localStorage.setItem('links', JSON.stringify(links));
                    renderLinks();
                }
            });

            renderLinks(); // Render links on page load

            // --- Backup and Restore Functionality ---
            const exportDataBtn = document.getElementById('exportDataBtn');
            const importFileInput = document.getElementById('importFileInput');
            const importDataBtn = document.getElementById('importDataBtn');

            exportDataBtn.addEventListener('click', () => {
                const allAppData = {
                    allNotes: JSON.parse(localStorage.getItem('allNotes')),
                    activeNoteId: localStorage.getItem('activeNoteId'),
                    todos: JSON.parse(localStorage.getItem('todos')),
                    timetable: JSON.parse(localStorage.getItem('timetable')),
                    homeworks: JSON.parse(localStorage.getItem('homeworks')),
                    links: JSON.parse(localStorage.getItem('links')),
                    pdfs: JSON.parse(localStorage.getItem('pdfs')),
                    darkMode: localStorage.getItem('darkMode')
                };

                const dataStr = JSON.stringify(allAppData, null, 2); // Pretty print JSON
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `study_hub_backup_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert('Data exported successfully!');
            });

            importDataBtn.addEventListener('click', () => {
                const file = importFileInput.files[0];
                if (!file) {
                    alert('Please select a JSON backup file to import.');
                    return;
                }

                if (file.type !== 'application/json') {
                    alert('Invalid file type. Please select a JSON file.');
                    return;
                }

                if (!confirm('Importing data will OVERWRITE all your current Study Hub data. Are you sure you want to proceed?')) {
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);

                        // Basic validation to ensure it's a valid backup structure
                        if (importedData && typeof importedData === 'object' &&
                            importedData.allNotes !== undefined &&
                            importedData.todos !== undefined &&
                            importedData.timetable !== undefined) {

                            localStorage.setItem('allNotes', JSON.stringify(importedData.allNotes));
                            if (importedData.activeNoteId !== undefined) {
                                localStorage.setItem('activeNoteId', importedData.activeNoteId);
                            } else {
                                localStorage.removeItem('activeNoteId');
                            }
                            localStorage.setItem('todos', JSON.stringify(importedData.todos));
                            localStorage.setItem('timetable', JSON.stringify(importedData.timetable));
                            localStorage.setItem('homeworks', JSON.stringify(importedData.homeworks));
                            localStorage.setItem('links', JSON.stringify(importedData.links));
                            localStorage.setItem('pdfs', JSON.stringify(importedData.pdfs));
                            if (importedData.darkMode !== undefined) {
                                localStorage.setItem('darkMode', importedData.darkMode);
                            } else {
                                 localStorage.removeItem('darkMode'); // Clear if not in backup
                            }

                            reloadAllData(); // Re-initialize all UI components with new data
                            alert('Data imported successfully!');

                        } else {
                            alert('Invalid backup file format. Please select a valid Study Hub backup JSON.');
                        }
                    } catch (error) {
                        console.error('Error parsing or importing data:', error);
                        alert('An error occurred during data import. Please check the file format.');
                    }
                };
                reader.readAsText(file);
            });
        });
    </script>
</body>
</html>
